---
import { getCollection } from 'astro:content';
import Layout from '@/layouts/Layout.astro';
import Container from '@/components/Container.astro';
import { dateRange } from '@/lib/utils';
import { useTranslations } from '@/i18n/utils';

export async function getStaticPaths() {
  return [{ params: { lang: 'es' } }, { params: { lang: 'en' } }];
}

const { lang } = Astro.params;
const t = useTranslations(lang as 'en' | 'es');

const collection = (await getCollection('work')).sort(
  (a, b) =>
    new Date(b.data.dateStart).valueOf() - new Date(a.data.dateStart).valueOf(),
);

const work = await Promise.all(
  collection
    .filter((item) => item.data.lang === lang)
    .map(async (item) => {
      const { Content } = await item.render();
      return { ...item, Content };
    }),
);
---

<Layout title={t('work.title')} description={t('work.description')}>
  <Container>
    <div class="space-y-10">
      {
        work.length === 0 ? (
          <div class="p-8 border border-(--border) border-dashed rounded-xl text-(--text-secondary) text-sm text-center animate">
            {t('empty.work')}
          </div>
        ) : (
          <ul class="relative">
            {/* Timeline line */}
            <div
              class="top-2 bottom-2 left-[11px] absolute bg-(--border) w-px"
              aria-hidden="true"
            />

            {work.map((entry, index) => (
              <li class="relative pb-10 last:pb-0 pl-10 animate">
                {/* Timeline dot */}
                <div class="top-1.5 left-0 absolute flex justify-center items-center bg-(--surface-elevated) border-(--accent) border-2 rounded-full w-6 h-6">
                  <div class="bg-(--accent) rounded-full w-2 h-2" />
                </div>

                <div class="p-5 card-interactive">
                  <div class="z-10 relative">
                    <div class="flex flex-wrap justify-between items-start gap-x-4 gap-y-2 mb-3">
                      <div>
                        <h3 class="font-semibold text-(--text-primary) text-lg">
                          {entry.data.company}
                        </h3>
                        <p class="text-(--text-secondary) text-sm">
                          {entry.data.role}
                        </p>
                      </div>
                      <span class="px-2 py-1 rounded font-mono text-(--accent) text-xs whitespace-nowrap bg-(--accent-muted)">
                        {dateRange(entry.data.dateStart, entry.data.dateEnd)}
                      </span>
                    </div>
                    <article class="text-sm">
                      <entry.Content />
                    </article>
                  </div>
                </div>
              </li>
            ))}
          </ul>
        )
      }
    </div>
  </Container>
</Layout>
